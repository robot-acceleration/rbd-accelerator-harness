# tb_dqBpassij
#
# Testbench for dqBpassij.jl

#-------------------------------------------------------------------------------
# Import Libraries
#-------------------------------------------------------------------------------
using LinearAlgebra
using FixedPointNumbers
using Test
include("../../../type_generic/dynamics/helpers_iiwa.jl")
include("dqBpassij.jl") # dqBpassij

#-------------------------------------------------------------------------------
# Data Type
#-------------------------------------------------------------------------------
CUSTOM_TYPE = Float64 ###Fixed{Int32,24} # data type

#-------------------------------------------------------------------------------
# Set Constants
#-------------------------------------------------------------------------------
X,Y,Z,AX,AY,AZ,LX,LY,LZ,g = initConstants(CUSTOM_TYPE)

#-------------------------------------------------------------------------------
# Define Test Function
#-------------------------------------------------------------------------------
function dqBpassijTest(CUSTOM_TYPE,X,Y,Z,AX,AY,AZ,LX,LY,LZ,dqj)
   #----------------------------------------------------------------------------
   # Inputs and Expected Outputs
   #----------------------------------------------------------------------------
   if (dqj == 5) # Input 5
      tXlist = [[0.956134 0.292928 0.0 0.0 0.0 0.0; -0.292928 0.956134 0.0 0.0 0.0 0.0; 0.0 0.0 1.0 0.0 0.0 0.0; -0.0461362 0.150591 0.0 0.956134 0.292928 0.0; -0.150591 -0.0461362 0.0 -0.292928 0.956134 0.0; 0.0 0.0 0.0 0.0 0.0 1.0], [-0.927773 0.0 0.373144 0.0 0.0 0.0; 0.373144 0.0 0.927773 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0; 0.0 -0.187874 0.0 -0.927773 0.0 0.373144; 0.0 0.0755618 0.0 0.373144 0.0 0.927773; -0.2025 0.0 0.0 0.0 1.0 0.0], [-0.826669 0.0 -0.562689 0.0 0.0 0.0; -0.562689 0.0 0.826669 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0; -0.11507 8.26669e-13 0.169054 -0.826669 0.0 -0.562689; 0.169054 5.62689e-13 0.11507 -0.562689 0.0 0.826669; 1.0e-12 0.0 0.0 0.0 1.0 0.0], [0.999945 0.0 -0.0104451 0.0 0.0 0.0; 0.0104451 0.0 0.999945 0.0 0.0 0.0; 0.0 -1.0 0.0 0.0 0.0 0.0; 0.0 0.215488 0.0 0.999945 0.0 -0.0104451; 0.0 0.00225091 0.0 0.0104451 0.0 0.999945; 0.2155 0.0 0.0 0.0 -1.0 0.0], [-0.668187 0.0 -0.743993 0.0 0.0 0.0; -0.743993 0.0 0.668187 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0; -0.137267 6.68187e-13 0.123281 -0.668187 0.0 -0.743993; 0.123281 7.43993e-13 0.137267 -0.743993 0.0 0.668187; 1.0e-12 0.0 0.0 0.0 1.0 0.0], [0.951994 0.0 0.306117 0.0 0.0 0.0; -0.306117 0.0 0.951994 0.0 0.0 0.0; 0.0 -1.0 0.0 0.0 0.0 0.0; -6.12234e-13 0.205155 1.90399e-12 0.951994 0.0 0.306117; -1.90399e-12 -0.0659682 -6.12234e-13 -0.306117 0.0 0.951994; 0.2155 0.0 0.0 0.0 -1.0 0.0], [0.662605 0.0 0.748969 0.0 0.0 0.0; 0.748969 0.0 -0.662605 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0; 0.0606665 0.0 -0.053671 0.662605 0.0 0.748969; -0.053671 0.0 -0.0606665 0.748969 0.0 -0.662605; 0.0 0.0 0.0 0.0 1.0 0.0]]
      flist = [[-0.386208; 0.368599; 0.28119; 0.818636; 1.98773; -3.07625], [0.0930661; 0.248573; 0.209472; -1.83265; -2.57865; 1.86775], [0.380028; 0.0151653; 0.251379; 0.210761; 2.40183; -2.49168], [0.925628; 0.297174; 0.0203749; -0.839812; -2.1552; -1.17263], [-0.376703; -0.860545; 0.287702; 0.13818; 1.44749; -1.98613], [0.0383153; 0.167; 0.859512; -0.890237; -1.39686; -1.30446], [0.122748; -0.0996843; 0.0769509; -1.83586; -2.03848; -0.211055]]
      dfi_dqj_list = [0.0 0.0 0.0 0.0 0.167419 0.0142073 0.0019181; 0.0 0.0 0.0 0.0 0.0882908 -0.00373699 0.0136536; 0.0 0.0 0.0 0.0 -0.00860167 -0.0121177 -0.00115177; 0.0 0.0 0.0 0.0 0.353863 1.22403 0.534541; 0.0 0.0 0.0 0.0 -1.47426 -0.395695 -0.0628049; 0.0 0.0 0.0 0.0 0.108658 2.21509 -0.0932076]
      dtaui_dqj_list_ref = [0.378066; 3.98288; 0.0238366; -1.65174; 0.00557162; -0.0446072; -0.00115177]
      dfi_dqj_temp_ref = [-1.08724 0.953922 -2.4059 -1.7487 0.800063 0.0615039 0.0019181; 4.71999 0.0238366 2.21821 0.00557162 0.479278 -0.00488876 0.0136536; 0.378066 3.98288 0.0238366 -1.65174 0.00557162 -0.0446072 -0.00115177; 3.64002 -3.88941 2.62864 2.62761 1.9612 1.53118 0.534541; 1.04253 0.0844938 3.05036 0.111945 -4.13132 -0.488903 -0.0628049; -1.37292 1.04253 0.0844938 -3.05036 0.111945 2.65706 -0.0932076]
   else
      tXlist = [[0.956134 0.292928 0.0 0.0 0.0 0.0; -0.292928 0.956134 0.0 0.0 0.0 0.0; 0.0 0.0 1.0 0.0 0.0 0.0; -0.0461362 0.150591 0.0 0.956134 0.292928 0.0; -0.150591 -0.0461362 0.0 -0.292928 0.956134 0.0; 0.0 0.0 0.0 0.0 0.0 1.0], [-0.927773 0.0 0.373144 0.0 0.0 0.0; 0.373144 0.0 0.927773 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0; 0.0 -0.187874 0.0 -0.927773 0.0 0.373144; 0.0 0.0755618 0.0 0.373144 0.0 0.927773; -0.2025 0.0 0.0 0.0 1.0 0.0], [-0.826669 0.0 -0.562689 0.0 0.0 0.0; -0.562689 0.0 0.826669 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0; -0.11507 8.26669e-13 0.169054 -0.826669 0.0 -0.562689; 0.169054 5.62689e-13 0.11507 -0.562689 0.0 0.826669; 1.0e-12 0.0 0.0 0.0 1.0 0.0], [0.999945 0.0 -0.0104451 0.0 0.0 0.0; 0.0104451 0.0 0.999945 0.0 0.0 0.0; 0.0 -1.0 0.0 0.0 0.0 0.0; 0.0 0.215488 0.0 0.999945 0.0 -0.0104451; 0.0 0.00225091 0.0 0.0104451 0.0 0.999945; 0.2155 0.0 0.0 0.0 -1.0 0.0], [-0.668187 0.0 -0.743993 0.0 0.0 0.0; -0.743993 0.0 0.668187 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0; -0.137267 6.68187e-13 0.123281 -0.668187 0.0 -0.743993; 0.123281 7.43993e-13 0.137267 -0.743993 0.0 0.668187; 1.0e-12 0.0 0.0 0.0 1.0 0.0], [0.951994 0.0 0.306117 0.0 0.0 0.0; -0.306117 0.0 0.951994 0.0 0.0 0.0; 0.0 -1.0 0.0 0.0 0.0 0.0; -6.12234e-13 0.205155 1.90399e-12 0.951994 0.0 0.306117; -1.90399e-12 -0.0659682 -6.12234e-13 -0.306117 0.0 0.951994; 0.2155 0.0 0.0 0.0 -1.0 0.0], [0.662605 0.0 0.748969 0.0 0.0 0.0; 0.748969 0.0 -0.662605 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0; 0.0606665 0.0 -0.053671 0.662605 0.0 0.748969; -0.053671 0.0 -0.0606665 0.748969 0.0 -0.662605; 0.0 0.0 0.0 0.0 1.0 0.0]]
      flist = [[-0.386208; 0.368599; 0.28119; 0.818636; 1.98773; -3.07625], [0.0930661; 0.248573; 0.209472; -1.83265; -2.57865; 1.86775], [0.380028; 0.0151653; 0.251379; 0.210761; 2.40183; -2.49168], [0.925628; 0.297174; 0.0203749; -0.839812; -2.1552; -1.17263], [-0.376703; -0.860545; 0.287702; 0.13818; 1.44749; -1.98613], [0.0383153; 0.167; 0.859512; -0.890237; -1.39686; -1.30446], [0.122748; -0.0996843; 0.0769509; -1.83586; -2.03848; -0.211055]]
      dfi_dqj_list = [0.0 0.0 0.0 0.0 0.167419 0.0142073 0.0019181; 0.0 0.0 0.0 0.0 0.0882908 -0.00373699 0.0136536; 0.0 0.0 0.0 0.0 -0.00860167 -0.0121177 -0.00115177; 0.0 0.0 0.0 0.0 0.353863 1.22403 0.534541; 0.0 0.0 0.0 0.0 -1.47426 -0.395695 -0.0628049; 0.0 0.0 0.0 0.0 0.108658 2.21509 -0.0932076]
      dtaui_dqj_list_ref = [0.378066; 3.98288; 0.0238366; -1.65174; 0.00557162; -0.0446072; -0.00115177]
      dfi_dqj_temp_ref = [-1.08724 0.953922 -2.4059 -1.7487 0.800063 0.0615039 0.0019181; 4.71999 0.0238366 2.21821 0.00557162 0.479278 -0.00488876 0.0136536; 0.378066 3.98288 0.0238366 -1.65174 0.00557162 -0.0446072 -0.00115177; 3.64002 -3.88941 2.62864 2.62761 1.9612 1.53118 0.534541; 1.04253 0.0844938 3.05036 0.111945 -4.13132 -0.488903 -0.0628049; -1.37292 1.04253 0.0844938 -3.05036 0.111945 2.65706 -0.0932076]
   end

   #----------------------------------------------------------------------------
   # Unit Under Test
   #----------------------------------------------------------------------------
   # output variable
   dtaui_dqj_list = zeros(CUSTOM_TYPE,7,1) # for all Links

   # local variables
   dfi_dqj_update = zeros(CUSTOM_TYPE,6,1)
   dfi_dqj_temp = zeros(CUSTOM_TYPE,6,8)  # for all Links (+1)

   # initialize local variables
   for link in 7:-1:1
      dfi_dqj_temp[:,(link+1)] = dfi_dqj_list[:,link]
   end

   # backward pass
   for link in 7:-1:1
      prev_link = (link-1)
      # update local variables
      tcurrXprev = tXlist[link]
      lcurr_f = flist[link]
      # set fcross boolean
      fcross = (link == dqj)
      # inputs
      ###println("# Link ",link)
      ###println("tcurrXprev = ",tcurrXprev)
      ###println("lcurr_f = ",lcurr_f)
      ###println("lcurr_dfi_dq = ",dfi_dqj_temp[:,(link+1)])
      ###println("fcross = ",fcross)
      ###println("lprev_dfi_dq = ",dfi_dqj_temp[:,(prev_link+1)])
      # backward pass step
      dtaui_dqj_list[link,1],
      dfi_dqj_temp[:,(prev_link+1)] = dqBpassij(CUSTOM_TYPE,X,Y,Z,AX,AY,AZ,LX,LY,LZ,
                                                tcurrXprev,lcurr_f,dfi_dqj_temp[:,(link+1)],
                                                fcross,dfi_dqj_temp[:,(prev_link+1)])
      # outputs
      ###println("dtaui_dqj_out = ",dtaui_dqj_list[link,1])
      ###println("lprev_dfi_dq_out = ",dfi_dqj_temp[:,(prev_link+1)])
   end

   #----------------------------------------------------------------------------
   # Print Outputs
   #----------------------------------------------------------------------------
   println("Input = ",dqj)
   println("Expected: ",dtaui_dqj_list_ref)
   println("Got:      ",dtaui_dqj_list)

   #----------------------------------------------------------------------------
   # Test Outputs
   #----------------------------------------------------------------------------
   @test dtaui_dqj_list_ref â‰ˆ dtaui_dqj_list atol=1e-5
   println("Test passed!")
end

#-------------------------------------------------------------------------------
# Set Test Parameters and Run Test
#-------------------------------------------------------------------------------
dqj = 5 # Input 5
dqBpassijTest(CUSTOM_TYPE,X,Y,Z,AX,AY,AZ,LX,LY,LZ,dqj)
