# tb_dqdBpassij
#
# Testbench for dqdBpassij.jl

#-------------------------------------------------------------------------------
# Import Libraries
#-------------------------------------------------------------------------------
using LinearAlgebra
using FixedPointNumbers
using Test
include("../../../type_generic/dynamics/helpers_iiwa.jl")
include("dqdBpassij.jl") # dqdBpassij

#-------------------------------------------------------------------------------
# Data Type
#-------------------------------------------------------------------------------
CUSTOM_TYPE = Float64 ###Fixed{Int32,24} # data type

#-------------------------------------------------------------------------------
# Set Constants
#-------------------------------------------------------------------------------
X,Y,Z,AX,AY,AZ,LX,LY,LZ,g = initConstants(CUSTOM_TYPE)

#-------------------------------------------------------------------------------
# Define Test Function
#-------------------------------------------------------------------------------
function dqdBpassijTest(CUSTOM_TYPE,X,Y,Z,AX,AY,AZ,LX,LY,LZ,dqdj)
   #----------------------------------------------------------------------------
   # Inputs and Expected Outputs
   #----------------------------------------------------------------------------
   if (dqdj == 5) # Input 5
      tXlist = [[0.956134 0.292928 0.0 0.0 0.0 0.0; -0.292928 0.956134 0.0 0.0 0.0 0.0; 0.0 0.0 1.0 0.0 0.0 0.0; -0.0461362 0.150591 0.0 0.956134 0.292928 0.0; -0.150591 -0.0461362 0.0 -0.292928 0.956134 0.0; 0.0 0.0 0.0 0.0 0.0 1.0], [-0.927773 0.0 0.373144 0.0 0.0 0.0; 0.373144 0.0 0.927773 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0; 0.0 -0.187874 0.0 -0.927773 0.0 0.373144; 0.0 0.0755618 0.0 0.373144 0.0 0.927773; -0.2025 0.0 0.0 0.0 1.0 0.0], [-0.826669 0.0 -0.562689 0.0 0.0 0.0; -0.562689 0.0 0.826669 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0; -0.11507 8.26669e-13 0.169054 -0.826669 0.0 -0.562689; 0.169054 5.62689e-13 0.11507 -0.562689 0.0 0.826669; 1.0e-12 0.0 0.0 0.0 1.0 0.0], [0.999945 0.0 -0.0104451 0.0 0.0 0.0; 0.0104451 0.0 0.999945 0.0 0.0 0.0; 0.0 -1.0 0.0 0.0 0.0 0.0; 0.0 0.215488 0.0 0.999945 0.0 -0.0104451; 0.0 0.00225091 0.0 0.0104451 0.0 0.999945; 0.2155 0.0 0.0 0.0 -1.0 0.0], [-0.668187 0.0 -0.743993 0.0 0.0 0.0; -0.743993 0.0 0.668187 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0; -0.137267 6.68187e-13 0.123281 -0.668187 0.0 -0.743993; 0.123281 7.43993e-13 0.137267 -0.743993 0.0 0.668187; 1.0e-12 0.0 0.0 0.0 1.0 0.0], [0.951994 0.0 0.306117 0.0 0.0 0.0; -0.306117 0.0 0.951994 0.0 0.0 0.0; 0.0 -1.0 0.0 0.0 0.0 0.0; -6.12234e-13 0.205155 1.90399e-12 0.951994 0.0 0.306117; -1.90399e-12 -0.0659682 -6.12234e-13 -0.306117 0.0 0.951994; 0.2155 0.0 0.0 0.0 -1.0 0.0], [0.662605 0.0 0.748969 0.0 0.0 0.0; 0.748969 0.0 -0.662605 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0; 0.0606665 0.0 -0.053671 0.662605 0.0 0.748969; -0.053671 0.0 -0.0606665 0.748969 0.0 -0.662605; 0.0 0.0 0.0 0.0 1.0 0.0]]
      flist = [[-0.386208; 0.368599; 0.28119; 0.818636; 1.98773; -3.07625], [0.0930661; 0.248573; 0.209472; -1.83265; -2.57865; 1.86775], [0.380028; 0.0151653; 0.251379; 0.210761; 2.40183; -2.49168], [0.925628; 0.297174; 0.0203749; -0.839812; -2.1552; -1.17263], [-0.376703; -0.860545; 0.287702; 0.13818; 1.44749; -1.98613], [0.0383153; 0.167; 0.859512; -0.890237; -1.39686; -1.30446], [0.122748; -0.0996843; 0.0769509; -1.83586; -2.03848; -0.211055]]
      dfi_dqdj_list = [0.0 0.0 0.0 0.0 0.0188723 0.00514722 0.000520647; 0.0 0.0 0.0 0.0 0.000236705 -0.0012909 0.00165163; 0.0 0.0 0.0 0.0 0.0 -0.00227473 -0.000351123; 0.0 0.0 0.0 0.0 -0.000797862 0.00117916 0.0461907; 0.0 0.0 0.0 0.0 -0.167551 -0.0014017 0.0152324; 0.0 0.0 0.0 0.0 0.0515384 -0.00250583 -0.0115452]
      dtaui_dqdj_list_ref = [0.0248603; 0.140087; 0.00176493; -0.0337579; 0.00110428; -0.00638236; -0.000351123]
      dfi_dqdj_temp_ref = [-0.0710406 0.0622355 -0.097635 -0.0632558 0.0324108 0.00871392 0.000520647; 0.178224 0.00176493 0.0578879 0.00110428 0.0163346 -0.00164202 0.00165163; 0.0248603 0.140087 0.00176493 -0.0337579 0.00110428 -0.00638236 -0.000351123; 0.188329 -0.18237 0.111973 0.111431 0.0442858 0.043194 0.0461907; 0.068932 0.0512686 0.159602 0.0524354 -0.189548 -0.0129469 0.0152324; -0.0204848 0.068932 0.0512686 -0.159602 0.0524354 0.0219965 -0.0115452]
   else
      tXlist = [[0.956134 0.292928 0.0 0.0 0.0 0.0; -0.292928 0.956134 0.0 0.0 0.0 0.0; 0.0 0.0 1.0 0.0 0.0 0.0; -0.0461362 0.150591 0.0 0.956134 0.292928 0.0; -0.150591 -0.0461362 0.0 -0.292928 0.956134 0.0; 0.0 0.0 0.0 0.0 0.0 1.0], [-0.927773 0.0 0.373144 0.0 0.0 0.0; 0.373144 0.0 0.927773 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0; 0.0 -0.187874 0.0 -0.927773 0.0 0.373144; 0.0 0.0755618 0.0 0.373144 0.0 0.927773; -0.2025 0.0 0.0 0.0 1.0 0.0], [-0.826669 0.0 -0.562689 0.0 0.0 0.0; -0.562689 0.0 0.826669 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0; -0.11507 8.26669e-13 0.169054 -0.826669 0.0 -0.562689; 0.169054 5.62689e-13 0.11507 -0.562689 0.0 0.826669; 1.0e-12 0.0 0.0 0.0 1.0 0.0], [0.999945 0.0 -0.0104451 0.0 0.0 0.0; 0.0104451 0.0 0.999945 0.0 0.0 0.0; 0.0 -1.0 0.0 0.0 0.0 0.0; 0.0 0.215488 0.0 0.999945 0.0 -0.0104451; 0.0 0.00225091 0.0 0.0104451 0.0 0.999945; 0.2155 0.0 0.0 0.0 -1.0 0.0], [-0.668187 0.0 -0.743993 0.0 0.0 0.0; -0.743993 0.0 0.668187 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0; -0.137267 6.68187e-13 0.123281 -0.668187 0.0 -0.743993; 0.123281 7.43993e-13 0.137267 -0.743993 0.0 0.668187; 1.0e-12 0.0 0.0 0.0 1.0 0.0], [0.951994 0.0 0.306117 0.0 0.0 0.0; -0.306117 0.0 0.951994 0.0 0.0 0.0; 0.0 -1.0 0.0 0.0 0.0 0.0; -6.12234e-13 0.205155 1.90399e-12 0.951994 0.0 0.306117; -1.90399e-12 -0.0659682 -6.12234e-13 -0.306117 0.0 0.951994; 0.2155 0.0 0.0 0.0 -1.0 0.0], [0.662605 0.0 0.748969 0.0 0.0 0.0; 0.748969 0.0 -0.662605 0.0 0.0 0.0; 0.0 1.0 0.0 0.0 0.0 0.0; 0.0606665 0.0 -0.053671 0.662605 0.0 0.748969; -0.053671 0.0 -0.0606665 0.748969 0.0 -0.662605; 0.0 0.0 0.0 0.0 1.0 0.0]]
      flist = [[-0.386208; 0.368599; 0.28119; 0.818636; 1.98773; -3.07625], [0.0930661; 0.248573; 0.209472; -1.83265; -2.57865; 1.86775], [0.380028; 0.0151653; 0.251379; 0.210761; 2.40183; -2.49168], [0.925628; 0.297174; 0.0203749; -0.839812; -2.1552; -1.17263], [-0.376703; -0.860545; 0.287702; 0.13818; 1.44749; -1.98613], [0.0383153; 0.167; 0.859512; -0.890237; -1.39686; -1.30446], [0.122748; -0.0996843; 0.0769509; -1.83586; -2.03848; -0.211055]]
      dfi_dqdj_list = [0.0 0.0 0.0 0.0 0.0188723 0.00514722 0.000520647; 0.0 0.0 0.0 0.0 0.000236705 -0.0012909 0.00165163; 0.0 0.0 0.0 0.0 0.0 -0.00227473 -0.000351123; 0.0 0.0 0.0 0.0 -0.000797862 0.00117916 0.0461907; 0.0 0.0 0.0 0.0 -0.167551 -0.0014017 0.0152324; 0.0 0.0 0.0 0.0 0.0515384 -0.00250583 -0.0115452]
      dtaui_dqdj_list_ref = [0.0248603; 0.140087; 0.00176493; -0.0337579; 0.00110428; -0.00638236; -0.000351123]
      dfi_dqdj_temp_ref = [-0.0710406 0.0622355 -0.097635 -0.0632558 0.0324108 0.00871392 0.000520647; 0.178224 0.00176493 0.0578879 0.00110428 0.0163346 -0.00164202 0.00165163; 0.0248603 0.140087 0.00176493 -0.0337579 0.00110428 -0.00638236 -0.000351123; 0.188329 -0.18237 0.111973 0.111431 0.0442858 0.043194 0.0461907; 0.068932 0.0512686 0.159602 0.0524354 -0.189548 -0.0129469 0.0152324; -0.0204848 0.068932 0.0512686 -0.159602 0.0524354 0.0219965 -0.0115452]
   end

   #----------------------------------------------------------------------------
   # Unit Under Test
   #----------------------------------------------------------------------------

   # output variable
   dtaui_dqdj_list = zeros(CUSTOM_TYPE,7,1) # for all Links

   # local variables
   dfi_dqdj_update = zeros(CUSTOM_TYPE,6,1)
   dfi_dqdj_temp = zeros(CUSTOM_TYPE,6,8)  # for all Links (+1)

   # initialize local variables
   for link in 7:-1:1
      dfi_dqdj_temp[:,(link+1)] = dfi_dqdj_list[:,link]
   end

   # backward pass
   for link in 7:-1:1
      prev_link = (link-1)
      # update local variables
      tcurrXprev = tXlist[link]
      lcurr_f = flist[link]
      # inputs
      ###println("# Link ",link)
      ###println("tcurrXprev = ",tcurrXprev)
      ###println("lcurr_dfi_dqd = ",dfi_dqdj_temp[:,(link+1)])
      ###println("lprev_dfi_dqd = ",dfi_dqdj_temp[:,(prev_link+1)])
      # backward pass step
      dtaui_dqdj_list[link,1],
      dfi_dqdj_temp[:,(prev_link+1)] = dqdBpassij(CUSTOM_TYPE,X,Y,Z,AX,AY,AZ,LX,LY,LZ,
                                                  tcurrXprev,dfi_dqdj_temp[:,(link+1)],
                                                  dfi_dqdj_temp[:,(prev_link+1)])
      # outputs
      ###println("dtaui_dqdj_out = ",dtaui_dqdj_list[link,1])
      ###println("lprev_dfi_dqd_out = ",dfi_dqdj_temp[:,(prev_link+1)])
   end

   #----------------------------------------------------------------------------
   # Print Outputs
   #----------------------------------------------------------------------------
   println("Input = ",dqdj)
   println("Expected: ",dtaui_dqdj_list_ref)
   println("Got:      ",dtaui_dqdj_list)

   #----------------------------------------------------------------------------
   # Test Outputs
   #----------------------------------------------------------------------------
   @test dtaui_dqdj_list_ref â‰ˆ dtaui_dqdj_list atol=1e-5
   println("Test passed!")
end

#-------------------------------------------------------------------------------
# Set Test Parameters and Run Test
#-------------------------------------------------------------------------------
dqdj = 5 # Input 5
dqdBpassijTest(CUSTOM_TYPE,X,Y,Z,AX,AY,AZ,LX,LY,LZ,dqdj)
