# tb_iDots
#
# Testbench for iDots.jl

#-------------------------------------------------------------------------------
# Import Libraries
#-------------------------------------------------------------------------------
using LinearAlgebra
using FixedPointNumbers
using Test
include("../../../type_generic/dynamics/helpers_iiwa.jl")
include("iDots.jl") # iDots

#-------------------------------------------------------------------------------
# Data Type
#-------------------------------------------------------------------------------
CUSTOM_TYPE = Float64 ###Fixed{Int32,24} # data type

#-------------------------------------------------------------------------------
# Set Constants
#-------------------------------------------------------------------------------
X,Y,Z,AX,AY,AZ,LX,LY,LZ,g = initConstants(CUSTOM_TYPE)
# Inertia Tensors, 7x[6x6]
l1_I,l2_I,l3_I,l4_I,l5_I,l6_I,l7_I = initInertiaTensors(CUSTOM_TYPE,X,Y,Z,AX,AY,AZ,LX,LY,LZ)

#-------------------------------------------------------------------------------
# Define Test Function
#-------------------------------------------------------------------------------
function iDotsTest(CUSTOM_TYPE,X,Y,Z,AX,AY,AZ,LX,LY,LZ,li)
   #----------------------------------------------------------------------------
   # Inputs and Expected Outputs
   #----------------------------------------------------------------------------
   if (li == 1) # Link 1
      imat = l1_I
      # Note: Same test vector as Link 4
      vec = [-1.15901; -0.0698891; -0.459015; 0.191503; 0.123849; -0.399976]
      ivec = [-0.198283; 0.074996; 0.0111412; 0.677383; 1.05172; -1.46082]
   elseif (li == 2) # Link 2
      imat = l2_I
      #imat = [0.07098 -7.08e-5 -5.04e-5 0.0 -0.168 0.236;
      #-7.08e-5 0.0250564 -0.009912 0.168 0.0 -0.0012;
      #-5.04e-5 -0.009912 0.0579244 -0.236 0.0012 0.0;
      #0.0 0.168 -0.236 4.0 0.0 0.0;
      #-0.168 0.0 0.0012 0.0 4.0 0.0;
      #0.236 -0.0012 0.0 0.0 0.0 4.0]
      vec = [0.528975; -0.483978; 0.0; 0.0; -0.0; 0.0]
      ivec = [0.0375809; -0.0121642; 0.00477053; -0.0813084; -0.0888677; 0.125419]
   elseif (li == 3) # Link 3
      imat = l3_I
      #imat = [0.1334 -0.0 -0.0 0.0 -0.39 0.09;
      #-0.0 0.1257 -0.0117 0.39 0.0 -0.0;
      #-0.0 -0.0117 0.0127 -0.09 0.0 0.0;
      #0.0 0.39 -0.09 3.0 0.0 0.0;
      #-0.39 0.0 0.0 0.0 3.0 0.0;
      #0.09 -0.0 0.0 0.0 0.0 3.0]
      vec = [-0.952324; 0.459015; -0.483978; 0.0938685; 0.19475; 5.28975e-13]
      ivec = [-0.202993; 0.0999694; -0.0199652; 0.504179; 0.955658; -0.0857092]
   elseif (li == 4) # Link 4
      imat = l4_I
      #imat = [0.0452415 -0.0 -0.0 0.0 -0.0918 0.1809;
      #-0.0 0.0131212 -0.0061506 0.0918 0.0 -0.0;
      #-0.0 -0.0061506 0.0411203 -0.1809 0.0 0.0;
      #0.0 0.0918 -0.1809 2.7 0.0 0.0;
      #-0.0918 0.0 0.0 0.0 2.7 0.0;
      #0.1809 -0.0 0.0 0.0 0.0 2.7]
      vec = [-1.15901; -0.0698891; -0.459015; 0.191503; 0.123849; -0.399976]
      ivec = [-0.136161; 0.0194862; -0.0530879; 0.593678; 0.440791; -1.2896]
   elseif (li == 5) # Link 5
      imat = l5_I
      #imat = [0.0305689 -3.57e-6 -1.292e-5 0.0 -0.1292 0.0357;
      #-3.57e-6 0.0278192 -0.0027132 0.1292 0.0 -0.00017;
      #-1.292e-5 -0.0027132 0.00574972 -0.0357 0.00017 0.0;
      #0.0 0.1292 -0.0357 1.7 0.0 0.0;
      #-0.1292 0.0 0.00017 0.0 1.7 0.0;
      #0.0357 -0.00017 0.0 0.0 0.0 1.7]
      vec = [1.51652; 0.502512; -0.0698891; 0.239553; -0.858309; 0.123849]
      ivec = [0.161672; 0.0450929; -0.0104828; 0.47466; -1.65507; 0.264598]
   elseif (li == 6) # Link 6
      imat = l6_I
      #imat = [0.00500094 -0.0 -0.0 0.0 -0.00072 0.00108;
      #-0.0 0.00360029 -4.32e-7 0.00072 0.0 -0.0;
      #-0.0 -4.32e-7 0.00470065 -0.00108 0.0 0.0;
      #0.0 0.00072 -0.00108 1.8 0.0 0.0;
      #-0.00072 0.0 0.0 0.0 1.8 0.0;
      #0.00108 -0.0 0.0 0.0 0.0 1.8]
      vec = [1.25244; -0.530315; -0.502512; 0.270273; -0.292613; 1.18512]
      ivec = [0.007754; -0.00171447; -0.0026538; 0.486652; -0.527605; 2.13457]
   elseif (li == 7) # Link 7
      imat = l7_I
      #imat = [0.00112 -0.0 -0.0 0.0 -0.006 0.0;
      #-0.0 0.00112 -0.0 0.006 0.0 -0.0;
      #-0.0 -0.0 0.001 -0.0 0.0 0.0;
      #0.0 0.006 -0.0 0.3 0.0 0.0;
      #-0.006 0.0 0.0 0.0 0.3 0.0;
      #0.0 -0.0 0.0 0.0 0.0 0.3]
      vec = [0.922416; 1.80227; -0.530315; 1.57566; -1.08263; -0.292613]
      ivec = [0.00752887; 0.0114725; -0.000530315; 0.483513; -0.330322; -0.0877839]
   end

   #----------------------------------------------------------------------------
   # Unit Under Test
   #----------------------------------------------------------------------------
   ivec_out = iDots(CUSTOM_TYPE,X,Y,Z,AX,AY,AZ,LX,LY,LZ,
                   imat,vec)

   #----------------------------------------------------------------------------
   # Print Outputs
   #----------------------------------------------------------------------------
   println("Link = ",li)
   println("Expected: ",ivec)
   println("Got:      ",ivec_out)

   #----------------------------------------------------------------------------
   # Test Outputs
   #----------------------------------------------------------------------------
   @test ivec_out â‰ˆ ivec atol=1e-5
   println("Test passed!")
end

#-------------------------------------------------------------------------------
# Set Test Parameters and Run Test
#-------------------------------------------------------------------------------
li = 1;
iDotsTest(CUSTOM_TYPE,X,Y,Z,AX,AY,AZ,LX,LY,LZ,li)
li = 2;
iDotsTest(CUSTOM_TYPE,X,Y,Z,AX,AY,AZ,LX,LY,LZ,li)
li = 3;
iDotsTest(CUSTOM_TYPE,X,Y,Z,AX,AY,AZ,LX,LY,LZ,li)
li = 4;
iDotsTest(CUSTOM_TYPE,X,Y,Z,AX,AY,AZ,LX,LY,LZ,li)
li = 5;
iDotsTest(CUSTOM_TYPE,X,Y,Z,AX,AY,AZ,LX,LY,LZ,li)
li = 6;
iDotsTest(CUSTOM_TYPE,X,Y,Z,AX,AY,AZ,LX,LY,LZ,li)
li = 7;
iDotsTest(CUSTOM_TYPE,X,Y,Z,AX,AY,AZ,LX,LY,LZ,li)