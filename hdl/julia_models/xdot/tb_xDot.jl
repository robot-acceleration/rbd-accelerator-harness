# tb_xDot
#
# Testbench for xDot.jl

#-------------------------------------------------------------------------------
# Import Libraries
#-------------------------------------------------------------------------------
using LinearAlgebra
using FixedPointNumbers
using Test
include("../../type_generic/dynamics/helpers_iiwa.jl")
include("xDot.jl") # xDot

#-------------------------------------------------------------------------------
# Data Type
#-------------------------------------------------------------------------------
CUSTOM_TYPE = Float64 ###Fixed{Int32,24} # data type

#-------------------------------------------------------------------------------
# Set Constants
#-------------------------------------------------------------------------------
X,Y,Z,AX,AY,AZ,LX,LY,LZ,g = initConstants(CUSTOM_TYPE)

#-------------------------------------------------------------------------------
# Define Test Function
#-------------------------------------------------------------------------------
function xDotTest(CUSTOM_TYPE,X,Y,Z,AX,AY,AZ,LX,LY,LZ,li,mcross_bool)
   #----------------------------------------------------------------------------
   # Inputs and Expected Outputs
   #----------------------------------------------------------------------------
   if (mcross_bool) # mcross
      if (li == 2) # Link 2
         xform =
         [-0.927773 0.0 0.373144 0.0 0.0 0.0;
         0.373144 0.0 0.927773 0.0 0.0 0.0;
         0.0 1.0 0.0 0.0 0.0 0.0;
         0.0 -0.187874 0.0 -0.927773 0.0 0.373144;
         0.0 0.0755618 0.0 0.373144 0.0 0.927773;
         -0.2025 0.0 0.0 0.0 1.0 0.0]
         vec = [0.0; 0.0; 0.999905; 0.0; 0.0; 0.0]
         xvec = [0.927685; -0.373109; 0.0; 0.0; -0.0; 0.0]
      elseif (li == 3) # Link 3
         xform =
         [-0.826669 0.0 -0.562689 0.0 0.0 0.0;
         -0.562689 0.0 0.826669 0.0 0.0 0.0;
         0.0 1.0 0.0 0.0 0.0 0.0;
         -0.11507 8.26669e-13 0.169054 -0.826669 0.0 -0.562689;
         0.169054 5.62689e-13 0.11507 -0.562689 0.0 0.826669;
         1.0e-12 0.0 0.0 0.0 1.0 0.0]
         vec = [0.373109; 0.927685; 0.251662; 0.0; 0.0; 0.0]
         xvec = [-0.00190277; 0.450045; 0.0; 0.0920342; 0.000389117; 0.0]
      elseif (li == 4) # Link 4
         xform =
         [0.999945 0.0 -0.0104451 0.0 0.0 0.0;
         0.0104451 0.0 0.999945 0.0 0.0 0.0;
         0.0 -1.0 0.0 0.0 0.0 0.0;
         0.0 0.215488 0.0 0.999945 0.0 -0.0104451;
         0.0 0.00225091 0.0 0.0104451 0.0 0.999945;
         0.2155 0.0 0.0 0.0 -1.0 0.0]
         vec = [-0.450045; -0.00190277; 1.91435; -0.000389117; 0.0920342; 3.73109e-13]
         xvec = [1.90955; 0.470016; 0.0; -8.34731e-6; 0.00079912; 0.0]
      elseif (li == 5) # Link 5
         xform =
         [-0.668187 0.0 -0.743993 0.0 0.0 0.0;
         -0.743993 0.0 0.668187 0.0 0.0 0.0;
         0.0 1.0 0.0 0.0 0.0 0.0;
         -0.137267 6.68187e-13 0.123281 -0.668187 0.0 -0.743993;
         0.123281 7.43993e-13 0.137267 -0.743993 0.0 0.668187;
         1.0e-12 0.0 0.0 0.0 1.0 0.0]
         vec = [-0.470016; 1.90955; 0.557654; -0.00079912; -8.34731e-6; -0.189019]
         xvec = [0.722306; 0.100832; 0.0; -0.107102; -0.274428; 0.0]
      elseif (li == 6) # Link 6
         xform =
         [0.951994 0.0 0.306117 0.0 0.0 0.0;
         -0.306117 0.0 0.951994 0.0 0.0 0.0;
         0.0 -1.0 0.0 0.0 0.0 0.0;
         -6.12234e-13 0.205155 1.90399e-12 0.951994 0.0 0.306117;
         -1.90399e-12 -0.0659682 -6.12234e-13 -0.306117 0.0 0.951994;
         0.2155 0.0 0.0 0.0 -1.0 0.0]
         vec = [-0.100832; 0.722306; 2.34665; 0.274428; -0.107102; -8.34731e-6]
         xvec = [2.26487; -0.622359; 0.0; -0.131664; -0.409436; 0.0]
      elseif (li == 7) # Link 7
         xform =
         [0.662605 0.0 0.748969 0.0 0.0 0.0;
         0.748969 0.0 -0.662605 0.0 0.0 0.0;
         0.0 1.0 0.0 0.0 0.0 0.0;
         0.0606665 0.0 -0.053671 0.662605 0.0 0.748969;
         -0.053671 0.0 -0.0606665 0.748969 0.0 -0.662605;
         0.0 0.0 0.0 0.0 1.0 0.0]
         vec = [0.622359; 2.26487; -0.297588; 0.409436; -0.131664; 0.0853726]
         xvec = [0.663311; -0.189494; 0.0; 0.234737; -0.388964; 0.0]
      end
   else # not mcross
      if (li == 3) # Link 3
         xform =
         [-0.826669 0.0 -0.562689 0.0 0.0 0.0;
         -0.562689 0.0 0.826669 0.0 0.0 0.0;
         0.0 1.0 0.0 0.0 0.0 0.0;
         -0.11507 8.26669e-13 0.169054 -0.826669 0.0 -0.562689;
         0.169054 5.62689e-13 0.11507 -0.562689 0.0 0.826669;
         1.0e-12 0.0 0.0 0.0 1.0 0.0]
         vec = [0.927685, -0.373109, 0.0, 0.0, -0.0, 0.0]
         xvec = [-0.766888; -0.521998; -0.373109; -0.106749; 0.156829; 9.27685e-13]
      elseif (li == 4) # Link 4
         xform =
         [0.999945 0.0 -0.0104451 0.0 0.0 0.0;
         0.0104451 0.0 0.999945 0.0 0.0 0.0;
         0.0 -1.0 0.0 0.0 0.0 0.0;
         0.0 0.215488 0.0 0.999945 0.0 -0.0104451;
         0.0 0.00225091 0.0 0.0104451 0.0 0.999945;
         0.2155 0.0 0.0 0.0 -1.0 0.0]
         vec = [-0.00190277, 0.450045, 0.0, 0.0920342, 0.000389117, 0.0]
         xvec = [-0.00190267; -1.98746e-5; -0.450045; 0.189009; 0.00197431; -0.000799164]
      elseif (li == 5) # Link 5
         xform =
         [-0.668187 0.0 -0.743993 0.0 0.0 0.0;
         -0.743993 0.0 0.668187 0.0 0.0 0.0;
         0.0 1.0 0.0 0.0 0.0 0.0;
         -0.137267 6.68187e-13 0.123281 -0.668187 0.0 -0.743993;
         0.123281 7.43993e-13 0.137267 -0.743993 0.0 0.668187;
         1.0e-12 0.0 0.0 0.0 1.0 0.0]
         vec = [1.90955, 0.470016, 0.0, -8.34731e-6, 0.00079912, 0.0]
         xvec = [-1.27593; -1.42069; 0.470016; -0.262112; 0.235416; 0.00079912]
      elseif (li == 6) # Link 6
         xform =
         [0.951994 0.0 0.306117 0.0 0.0 0.0;
         -0.306117 0.0 0.951994 0.0 0.0 0.0;
         0.0 -1.0 0.0 0.0 0.0 0.0;
         -6.12234e-13 0.205155 1.90399e-12 0.951994 0.0 0.306117;
         -1.90399e-12 -0.0659682 -6.12234e-13 -0.306117 0.0 0.951994;
         0.2155 0.0 0.0 0.0 -1.0 0.0]
         vec = [0.722306, 0.100832, 0.0, -0.107102, -0.274428, 0.0]
         xvec = [0.687631; -0.22111; -0.100832; -0.0812742; 0.026134; 0.430085]
      elseif (li == 7) # Link 7
         xform =
         [0.662605 0.0 0.748969 0.0 0.0 0.0;
         0.748969 0.0 -0.662605 0.0 0.0 0.0;
         0.0 1.0 0.0 0.0 0.0 0.0;
         0.0606665 0.0 -0.053671 0.662605 0.0 0.748969;
         -0.053671 0.0 -0.0606665 0.748969 0.0 -0.662605;
         0.0 0.0 0.0 0.0 1.0 0.0]
         vec = [2.26487, -0.622359, 0.0, -0.131664, -0.409436, 0.0]
         xvec = [1.50071; 1.69632; -0.622359; 0.0501602; -0.22017; -0.409436]
      end
   end

   #----------------------------------------------------------------------------
   # Unit Under Test
   #----------------------------------------------------------------------------
   xvec_out = xDot(CUSTOM_TYPE,X,Y,Z,AX,AY,AZ,LX,LY,LZ,
                  xform,vec,mcross_bool)

   #----------------------------------------------------------------------------
   # Print Outputs
   #----------------------------------------------------------------------------
   println("Link = ",li,", mcross = ",mcross_bool)
   println("Expected: ",xvec)
   println("Got:      ",xvec_out)

   #----------------------------------------------------------------------------
   # Test Outputs
   #----------------------------------------------------------------------------
   @test xvec_out â‰ˆ xvec atol=1e-5
   println("Test passed!")
end

#-------------------------------------------------------------------------------
# Set Test Parameters and Run Test
#-------------------------------------------------------------------------------
li = 2; mcross_bool = true
xDotTest(CUSTOM_TYPE,X,Y,Z,AX,AY,AZ,LX,LY,LZ,li,mcross_bool)
li = 3; mcross_bool = true
xDotTest(CUSTOM_TYPE,X,Y,Z,AX,AY,AZ,LX,LY,LZ,li,mcross_bool)
li = 3; mcross_bool = false
xDotTest(CUSTOM_TYPE,X,Y,Z,AX,AY,AZ,LX,LY,LZ,li,mcross_bool)
li = 4; mcross_bool = true
xDotTest(CUSTOM_TYPE,X,Y,Z,AX,AY,AZ,LX,LY,LZ,li,mcross_bool)
li = 4; mcross_bool = false
xDotTest(CUSTOM_TYPE,X,Y,Z,AX,AY,AZ,LX,LY,LZ,li,mcross_bool)
li = 5; mcross_bool = true
xDotTest(CUSTOM_TYPE,X,Y,Z,AX,AY,AZ,LX,LY,LZ,li,mcross_bool)
li = 5; mcross_bool = false
xDotTest(CUSTOM_TYPE,X,Y,Z,AX,AY,AZ,LX,LY,LZ,li,mcross_bool)
li = 6; mcross_bool = true
xDotTest(CUSTOM_TYPE,X,Y,Z,AX,AY,AZ,LX,LY,LZ,li,mcross_bool)
li = 6; mcross_bool = false
xDotTest(CUSTOM_TYPE,X,Y,Z,AX,AY,AZ,LX,LY,LZ,li,mcross_bool)
li = 7; mcross_bool = true
xDotTest(CUSTOM_TYPE,X,Y,Z,AX,AY,AZ,LX,LY,LZ,li,mcross_bool)
li = 7; mcross_bool = false
xDotTest(CUSTOM_TYPE,X,Y,Z,AX,AY,AZ,LX,LY,LZ,li,mcross_bool)
